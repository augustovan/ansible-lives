- hosts: 127.0.0.1 # all | testepunk  | "{{ tenant }}"
  connection: local
  #become: yes
  #become_user: root #dica de segurança / not all become / root all?
  # em que python está rodando antes de instalar o boto? importante ver

  tasks:
  # - name: ensure apache is at the latest version
  #   yum:
  #     name: httpd
  #     state: latest
  - ec2:
      key_name: camidevops
      region: us-east-2
      instance_type: t2.micro
      image: ami-026dea5602e368e96
      wait: yes
      count: 1
      group: default
      instance_tags:
        Name: teste1
      monitoring: yes
      termination_protection: yes
      assign_public_ip: yes
      vpc_subnet_id: subnet-0ca60f40
    register: deviceidlaunch

#- name: sleep for 120 seconds and continue with play
#  wait_for:
#    timeout: 120

  - name: allocate a new elastic IP and associate it with an instance
    ec2_eip:
      device_id: "{{ deviceidlaunch.instance_ids }}" #{{ item }}
    #loop: "{{ deviceidlaunch.instance_ids }}"
    register: elasticip

  - name: output the IP
    debug:
      msg: "Allocated IP inside a VPC is {{ elasticip.public_ip }}"

  - name: Wait for SSH to come up
    delegate_to: "{{ item.public_dns_name }}"
    wait_for_connection:
      delay: 60
      timeout: 320
    loop: "{{ deviceidlaunch.instances }}"

  - name: Cat hosts
    command: cat /etc/ansible/hosts
    register: hostsfileansible

  - name: Add a line to ansible hosts
    lineinfile:
      path: /etc/ansible/hosts
      line: "[{{testeec2}}]\n{{elasticip.public_ip}}\tansible_ssh_private_key_file=/home/ec2-user/camidevops.pem"
      create: yes
    when: '"{{testeec2}}" not in hostsfileansible.stdout' #comentar o verbose

  - name: run playbook
    command: ansible-playbook playbook-inicial.yml --extra-vars="testeec2={{testeec2}}"